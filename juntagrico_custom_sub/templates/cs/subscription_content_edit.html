{% extends "base.html" %}
{% load l10n %}
{% load config %}
{% load cs_config %}
{% block page_title %}
{% load staticfiles %}
<link rel="stylesheet" type="text/css" href="{% static 'juntagrico_custom_sub/style.css' %}">
<h3>{% vocabulary "subscription" %} Zusammenstellung</h3>
{% endblock %}

{% block content %}
<p>Dein {{ future_subscription_size }} {% cs_vocabulary "base_unit" %} {% vocabulary "subscription" %} enthält folgende
    Produkte:</p>
<p id="remainingUnits"></p>
<form method="post" action=""> {% csrf_token %}
    <table>
        {% for product in products %}
            <tr {% if product.amount_in_subscription == 0 and not product.user_editable %} style="display: none" {% endif %}>
                <td>
                    <div>{{ product.display_units }} {{ product.unit_name }} {{ product.name }}</div>
                    <small>entspricht {{ product.units }} {% cs_vocabulary "base_unit" %}</small>
                </td>
                <td >
                    <div class="pflichtprod">
                        {% if not product.user_editable %}
                            <span class="alert alert-warning">Pflichtprodukt - Ändern nicht möglich</span>
                        {% endif %}
                        <button class="btn btn-decrement" id="removeProduct{{ product.id }}" type=button
                            {% if not product.user_editable %} disabled {% endif %}>-</button>
                    </div>
                </td>
                <td><input type="number" value="{{ product.amount_in_subscription}}" min=0 name="amount{{ product.id }}"
                        id="valueProduct{{ product.id }}" style="text-align: center;" readonly></input></td>
                <td>
                    <div class="pflichtprod">
                        {% if not product.user_editable %}
                            <span class="alert alert-warning">Pflichtprodukt - Ändern nicht möglich</span>
                        {% endif %}
                        <button class="btn btn-increment" id="addProduct{{ product.id }}" type=button
                            {% if not product.user_editable %} disabled {% endif %}>+</button>
                    </div>
                </td>
            </tr>
        {% endfor %}
    </table>
    <button id="formSubmit" class="btn btn-success" type="submit" name="saveContent">Aboinhalt speichern</button>
</form>
{% localize off %}
<script type='text/javascript'>
    window.onload = function () {
        calculateRemainingUnits();
        var contentLeft = '{{ subscription_remaining }}';
        {% for product in products %}
        $('#addProduct{{ product.id }}').click(function () {
            var oldVal = +$('#valueProduct{{ product.id }}').val();
            if (getTotalUsedUnits() + {{ product.units }} <= {{ future_subscription_size }})
            {
                $('#valueProduct{{ product.id }}').val(oldVal + 1);
            }
            calculateRemainingUnits();
        });
    $('#removeProduct{{ product.id }}').click(function () {
        var oldVal = +$('#valueProduct{{ product.id }}').val();
        if (oldVal > 0 && oldVal > {{ product.min_amount }}) {
            $('#valueProduct{{ product.id }}').val(oldVal - 1);
            calculateRemainingUnits();
        };
    });
    {% endfor %}
    };
    function calculateRemainingUnits() {
        var remaining = {{ future_subscription_size }} - getTotalUsedUnits();
        $("#formSubmit").attr("disabled", remaining != 0);
        if (remaining == 0) {
            $('#remainingUnits').hide();
        }
        else {
            $('#remainingUnits').text("Noch " + remaining + " {% cs_vocabulary 'base_unit' %} zu verteilen");
            $('#remainingUnits').show();
        }
    };

    function getTotalUsedUnits() {
        var totalUsed = 0;
        {% for product in products %}
            totalUsed += +$('#valueProduct{{ product.id }}').val() * {{ product.units }};
        {% endfor %}
    return totalUsed;
    };
</script>
{% endlocalize %}
{% endblock %}